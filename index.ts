import { Context, Telegraf, Markup, session } from "telegraf";
import { message } from "telegraf/filters";

const REQUEST_TIMEOUT = 60 * 1000; // 60 seconds;

async function requestCode(restId: number) {
  const res = await fetch(
    `https://evrasia.spb.ru/api/v1/restaurant-discount/?REST_ID=${restId}`,
    {
      headers: {
        accept: "application/json, text/javascript, */*; q=0.01",
        "accept-language": "ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7",
        "sec-ch-ua":
          '"Google Chrome";v="123", "Not:A-Brand";v="8", "Chromium";v="123"',
        "sec-ch-ua-mobile": "?0",
        "sec-ch-ua-platform": '"macOS"',
        "sec-fetch-dest": "empty",
        "sec-fetch-mode": "cors",
        "sec-fetch-site": "same-origin",
        "x-requested-with": "XMLHttpRequest",
        cookie:
          "CHOOSED_RESTAURANT_EVERYTIME=true; BITRIX_SM_LOGIN=%2B7+%28995%29+661-78-79; BITRIX_SM_SOUND_LOGIN_PLAYED=Y; PHPSESSID=20d76ec97701750131052d60a6c35193; BITRIX_SM_UIDH=cd2e45944d5ae042211668ac50b09484; BITRIX_SM_UIDL=%2B7+%28995%29+661-78-79; BITRIX_SM_SALE_UID=209445630; BITRIX_CONVERSION_CONTEXT_s1=%7B%22ID%22%3A11%2C%22EXPIRE%22%3A1712437140%2C%22UNIQUE%22%3A%5B%22conversion_visit_day%22%5D%7D; cf_clearance=4.Q_Id11KkCUd43.mjWfRviC79RJ2GBPWmwtkpggJnw-1712391595-1.0.1.1-u6rkP4aRzzCqKTtmcH6a4l2AeCJ9TfzCqOOaGW_qDwxbC7lKHLQS06EyWJZIAJ01Hs9QKi1jeDbfuYY566Pxsg",
        Referer: "https://evrasia.spb.ru/account/",
        "Referrer-Policy": "strict-origin-when-cross-origin",
      },
      body: null,
      method: "GET",
    }
  );

  const r = await res.json();

  if (r.checkin) {
    return r.checkin;
  } else {
    return "";
  }
}

const RESTS = [
  {
    id: 214,
    name: "–°–µ—Å—Ç—Ä–æ—Ä–µ—Ü–∫, –ü—Ä–∏–º–æ—Ä—Å–∫–æ–µ —à., 348",
  },
  {
    id: 215,
    name: "–ö—Ä–æ–Ω—à—Ç–∞–¥—Ç, –ø—Ä. –õ–µ–Ω–∏–Ω–∞, 31",
  },
  {
    id: 222,
    name: "–ø—Ä. –ü—Ä–æ—Å–≤–µ—â–µ–Ω–∏—è, 32",
  },
  {
    id: 224,
    name: "–ø—Ä. –≠–Ω–≥–µ–ª—å—Å–∞, 134 –∫.3",
  },
  {
    id: 228,
    name: "–ø—Ä. –ü—Ä–æ—Å–≤–µ—â–µ–Ω–∏—è, 78",
  },
  {
    id: 230,
    name: "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø—Ä., 116",
  },
  {
    id: 234,
    name: "–ö–æ–º–µ–Ω–¥–∞–Ω—Ç—Å–∫–∏–π –ø—Ä., 13 –∫.1",
  },
  {
    id: 236,
    name: "–ø—Ä. –≠–Ω–≥–µ–ª—å—Å–∞, 21",
  },
  {
    id: 237,
    name: "–ö—Ä–µ—Å—Ç–æ–≤—Å–∫–∏–π –ø—Ä., 24",
  },
  {
    id: 238,
    name: "–Ω–∞–±. –ß–µ—Ä–Ω–æ–π —Ä–µ—á–∫–∏, 51–ê",
  },
  {
    id: 240,
    name: "–ü–∏—Å–∫–∞—Ä–µ–≤—Å–∫–∏–π –ø—Ä., 25",
  },
  {
    id: 258,
    name: "–õ–µ–Ω–∏–Ω—Å–∫–∏–π –ø—Ä., 95",
  },
  {
    id: 260,
    name: "–ö—Ä–æ–Ω–≤–µ—Ä–∫—Å–∫–∏–π –ø—Ä., 13/2",
  },
  {
    id: 261,
    name: "–õ–∏—Ç–µ–π–Ω—ã–π –ø—Ä., 28",
  },
  {
    id: 263,
    name: "–ø—Ä. –°—Ç–∞—á–µ–∫, 99 (–¢–†–ö –ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç, 3 —ç—Ç–∞–∂)",
  },
  {
    id: 265,
    name: "–ø—Ä. –°—Ç–∞—á–µ–∫, 77",
  },
  {
    id: 266,
    name: "—É–ª. –ñ—É–∫–æ–≤—Å–∫–æ–≥–æ, 36",
  },
  {
    id: 268,
    name: "–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∏–π –ø—Ä., 14",
  },
  {
    id: 269,
    name: "–ú–æ—Å–∫–æ–≤—Å–∫–∏–π –ø—Ä., 145",
  },
  {
    id: 275,
    name: "–¢—Ä—É–¥–∞ –ø–ª., 3",
  },
  {
    id: 278,
    name: "—É–ª. –§—É—á–∏–∫–∞, 2–ê (–¢–†–¶ –†–∏–æ, 1 —ç—Ç–∞–∂)",
  },
  {
    id: 282,
    name: "–õ–∏–≥–æ–≤—Å–∫–∏–π –ø—Ä., 93",
  },
  {
    id: 283,
    name: "—É–ª. –ë–µ–ª—ã –ö—É–Ω–∞, 3 (–¢–†–ö –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π, 3 —ç—Ç–∞–∂)",
  },
  {
    id: 289,
    name: "–ó–∞–≥–æ—Ä–æ–¥–Ω—ã–π –ø—Ä., 64",
  },
  {
    id: 292,
    name: "–ó–∞–Ω–µ–≤—Å–∫–∏–π –ø—Ä., 67/2",
  },
  {
    id: 295,
    name: "–ú–æ—Å–∫–æ–≤—Å–∫–∏–π –ø—Ä., 195",
  },
  {
    id: 298,
    name: "–ò–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω—ã–π –ø—Ä., 26/24",
  },
  {
    id: 300,
    name: "–ú–æ—Å–∫–æ–≤—Å–∫–∏–π –ø—Ä., 222",
  },
  {
    id: 306,
    name: "–ë–æ–ª—å—à–∞—è –ú–æ—Ä—Å–∫–∞—è, 13",
  },
  {
    id: 307,
    name: "–ø—Ä. –°–ª–∞–≤—ã, 43",
  },
  {
    id: 311,
    name: "–ë–∞–ª–∫–∞–Ω—Å–∫–∞—è –ø–ª., 5 (–¢–¶ –ë–∞–ª–∫–∞–Ω–∏—è Nova, 2 —ç—Ç–∞–∂)",
  },
  {
    id: 312,
    name: "–ø—Ä. –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤, 2",
  },
  {
    id: 313,
    name: "–Ω–∞–±. –∫–∞–Ω–∞–ª–∞ –ì—Ä–∏–±–æ–µ–¥–æ–≤–∞, 10/12",
  },
  {
    id: 314,
    name: "–ü—É–ª–∫–æ–≤—Å–∫–æ–µ —à., 25, –∫.1 (–¢–†–ö –õ–µ—Ç–æ, 2 —ç—Ç–∞–∂)",
  },
  {
    id: 315,
    name: "–®–µ—Ä–µ–º–µ—Ç—å–µ–≤—Å–∫–∞—è —É–ª., 13 (–¢–¶ –ú–∞—Å—à—Ç–∞–±, 1 —ç—Ç–∞–∂)",
  },
  {
    id: 318,
    name: "–Ω–∞–±. –∫–∞–Ω–∞–ª–∞ –ì—Ä–∏–±–æ–µ–¥–æ–≤–∞, 22/5",
  },
  {
    id: 320,
    name: "–õ–æ–º–æ–Ω–æ—Å–æ–≤, —É–ª. –ö—Ä–∞—Å–Ω–æ–∞—Ä–º–µ–π—Å–∫–∞—è, 19–ê (–¢–¶ –†–∞–º–±–æ–≤, 3 —ç—Ç–∞–∂)",
  },
  {
    id: 323,
    name: "–ü—É—à–∫–∏–Ω, –û–∫—Ç—è–±—Ä—å—Å–∫–∏–π –±—É–ª., 7",
  },
  {
    id: 324,
    name: "–ö—Ä–∞—Å–Ω–æ–µ –°–µ–ª–æ, –ø—Ä. –õ–µ–Ω–∏–Ω–∞, 51 (–¢–ö –¢–µ—Ç—Ä–∏—Å, 1 —ç—Ç–∞–∂)",
  },
  {
    id: 325,
    name: "–ì–∞—Ç—á–∏–Ω–∞, –ø—Ä. 25 –æ–∫—Ç—è–±—Ä—è, 59",
  },
  {
    id: 327,
    name: "–ö–æ–ª–ø–∏–Ω–æ, –û–∫—Ç—è–±—Ä—å—Å–∫–∞—è —É–ª., 8",
  },
  {
    id: 331,
    name: "–ö–æ–ª–ø–∏–Ω–æ, —É–ª. –ü—Ä–æ–ª–µ—Ç–∞—Ä—Å–∫–∞—è, 7–ê",
  },
  {
    id: 502,
    name: "–ü—Ä–∏–æ–∑–µ—Ä—Å–∫, —É–ª. –ö–∞–ª–∏–Ω–∏–Ω–∞, 11",
  },
  {
    id: 503,
    name: "–í—ã–±–æ—Ä–≥, –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–π –ø—Ä., 29/2",
  },
  {
    id: 3670,
    name: "–±—É–ª. –ù–æ–≤–∞—Ç–æ—Ä–æ–≤, 32",
  },
  {
    id: 137979,
    name: "–ö—É–¥—Ä–æ–≤–æ, –ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–π –ø—Ä., 8",
  },
  {
    id: 142183,
    name: "–Ø–∫–æ—Ä–Ω–∞—è —É–ª., 5–ê, (–¢–†–¶ –û—Ö—Ç–∞ –ú–æ–ª–ª, 3 —ç—Ç–∞–∂)",
  },
  {
    id: 645308,
    name: "–ö–∞–º–µ–Ω–Ω–æ–æ—Å—Ç—Ä–æ–≤—Å–∫–∏–π –ø—Ä., 44",
  },
  {
    id: 645322,
    name: "–ë–æ–ª—å—à–∞—è –ö–æ–Ω—é—à–µ–Ω–Ω–∞—è —É–ª., 10",
  },
  {
    id: 645326,
    name: "–ò—Ç–∞–ª—å—è–Ω—Å–∫–∞—è —É–ª., 29",
  },
  {
    id: 741759,
    name: "–ó–∞–Ω–µ–≤—Å–∫–∏–π –ø—Ä., 71 –∫.2 (–¢–†–ö –ó–∞–Ω–µ–≤—Å–∫–∏–π –∫–∞—Å–∫–∞–¥, 4 —ç—Ç–∞–∂) –î–µ—Ç—Å–∫–∏–π –∫–ª—É–±",
  },
  {
    id: 801338,
    name: "—É–ª. –ï—Ñ–∏–º–æ–≤–∞, 2. (–¢–†–ö –ü–∏–∫, 2 —ç—Ç–∞–∂)",
  },
  {
    id: 839130,
    name: "–ù–µ–≤—Å–∫–∏–π –ø—Ä., 42",
  },
  {
    id: 869805,
    name: "—É–ª. –°–∞–≤—É—à–∫–∏–Ω–∞, 141 (–¢–†–ö –ú–µ—Ä–∫—É—Ä–∏–π, 3 —ç—Ç–∞–∂)",
  },
  {
    id: 875269,
    name: "–ø—Ä. –≠–Ω–≥–µ–ª—å—Å–∞, 154 (–¢–†–ö –ì—Ä–∞–Ω–¥ –ö–∞–Ω—å–æ–Ω, 3 —ç—Ç–∞–∂)",
  },
  {
    id: 888767,
    name: "–ü–µ—Ç–µ—Ä–≥–æ—Ñ—Å–∫–æ–µ —à., 51–ê (–¢–†–¶ –ñ–µ–º—á—É–∂–Ω–∞—è –ü–ª–∞–∑–∞, 1 —ç—Ç–∞–∂)",
  },
  {
    id: 1039378,
    name: "–ø—Ä. –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤, 18 –∫.2 (–¢–†–ö –ù–µ–≤—Å–∫–∏–π, 4 —ç—Ç–∞–∂)",
  },
  {
    id: 1074699,
    name: "6 –ª–∏–Ω–∏—è –í–∞—Å–∏–ª—å–µ–≤—Å–∫–æ–≥–æ –æ—Å—Ç—Ä–æ–≤–∞,17-19",
  },
  {
    id: 1153645,
    name: "–ú–æ—Å–∫–æ–≤—Å–∫–∏–π –ø—Ä., 157",
  },
  {
    id: 1308568,
    name: "–ú—É—Ä–º–∞–Ω—Å–∫–æ–µ —à., 12-–π –∫–º, 1–ê (–°–¢–¶ –ú–µ–≥–∞ –î—ã–±–µ–Ω–∫–æ)",
  },
  {
    id: 1457827,
    name: "–ó–∞—Ö–∞—Ä—å–µ–≤—Å–∫–∞—è —É–ª., 27",
  },
  {
    id: 1663583,
    name: "–ú—É—Ä–∏–Ω–æ, –ï–∫–∞—Ç–µ—Ä–∏–Ω–∏–Ω—Å–∫–∞—è —É–ª. 17",
  },
];

const TOKEN = process.env.TOKEN || "";
const DOMAIN = "telegrafbot.vercel.app";
const PORT = 8080;

interface BotContext extends Context {
  session?: {
    lastRequestTime: Date;
  };
}
async function startBot() {
  const bot = new Telegraf<BotContext>(TOKEN);

  bot.use(session());

  const restaurantsList = Markup.keyboard(
    RESTS.map((rest) => Markup.button.callback(rest.name, rest.name))
  );

  bot.start((ctx) => {
    ctx.replyWithHTML(
      `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏ –ø–æ –∫—Ä–∞—Å–Ω–æ–π –∫–∞—Ä—Ç–µ –ï–≤—Ä–∞–∑–∏—è
–ù–∞–ø–∏—à–∏—Ç–µ <b>/menu</b> –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
    `
    );
  });

  bot.command("menu", async (ctx) => {
    ctx.reply("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω", restaurantsList);
  });

  bot.command("help", async (ctx) => {
    ctx.replyWithHTML(`
<b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏ –≤ –∑–∞–≤–µ–¥–µ–Ω–∏–∏:</b>
1Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /menu
2Ô∏è‚É£ –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ –æ—Ç –±–æ—Ç–∞
3Ô∏è‚É£ –°–∫–∞–∂–∏—Ç–µ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç—É —á—Ç–æ —É –≤–∞—Å –ö—Ä–∞—Å–Ω–∞—è –∫–∞—Ä—Ç–∞
4Ô∏è‚É£ –ù–∞–∑–æ–≤–∏—Ç–µ –µ–º—É –∫–æ–¥ –∏–∑ –±–æ—Ç–∞ (4 —Ü–∏—Ñ—Ä—ã)
5Ô∏è‚É£ –ü—Ä–æ—Ñ–∏—Ç! –ö—Ä–∞—Å–Ω—ã–µ —Ü–µ–Ω—ã —Ç–µ–ø–µ—Ä—å –≤–∞—à–∏.

–ü–æ –∫—Ä–∞—Å–Ω–æ–π –±–æ–Ω—É—Å–Ω–æ–π –∫–∞—Ä—Ç–µ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —Å–∫–∏–¥–∫—É –Ω–∞ –º–µ–Ω—é (–∫—Ä–∞—Å–Ω—ã–µ —Ü–µ–Ω—ã) –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∞—Ç—å –≤—ã–≥–æ–¥–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
üí≤–ü–ª—é—Å—ã –∫–∞—Ä—Ç—ã - –ø–æ–ª—É—á–∞–µ—Ç–µ –°–ö–ò–î–ö–£ 30% –Ω–∞ –≤—Å–µ –±–ª—é–¥–∞ –≤ –º–µ–Ω—é –∏ –¥–∞–∂–µ –Ω–∞ –∞–ª–∫–æ–≥–æ–ª—å üçæ
1Ô∏è‚É£‚ûï1Ô∏è‚É£ –î–µ–π—Å—Ç–≤—É–µ—Ç 1+1 –≤ —Å—á–∞—Å—Ç–ª–∏–≤—ã–µ —á–∞—Å—ã –∏ –∫—Ä–∞—Å–Ω—ã–µ —Ü–µ–Ω–Ω–∏–∫–∏.
`);
  });

  bot.on(message("text"), async (ctx) => {
    const text = ctx.message.text;

    if (
      ctx.session?.lastRequestTime &&
      new Date().getTime() - ctx.session.lastRequestTime?.getTime() <
        REQUEST_TIMEOUT
    ) {
      ctx.replyWithHTML(
        `–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –∫–æ–¥ –º–æ–∂–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ <b>1 –º–∏–Ω—É—Ç—É</b>`
      );
      return;
    }

    const resto = RESTS.find((rest) => rest.name.includes(text));

    if (resto) {
      try {
        const result = await requestCode(resto.id);
        ctx.session ??= { lastRequestTime: new Date() };

        if (!!result) {
          ctx.replyWithHTML(
            `–ö–æ–¥ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ <i>${resto.name}</i>: <b>${result}</b>`,
            {
              reply_markup: {
                remove_keyboard: true,
              },
            }
          );
        } else {
          ctx.replyWithHTML(`<b>–ù–µ</b> —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥`);
        }
      } catch (err) {
        ctx.replyWithHTML(`<b>–ù–µ</b> —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥`);
      }
    } else {
      ctx.replyWithHTML(`<b>–ù–µ</b> —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º`);
    }
  });

  bot
    .launch({ webhook: { domain: DOMAIN, port: PORT } })
    .then(() => console.log("Webhook bot listening on port", PORT));
}

startBot();
